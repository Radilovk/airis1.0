# Ориентационни бележки за разработка

Тази бележка служи за бърза ориентация в основната логика на Airis (React/Vite front-end за ирисова диагностика) без да се рови из множество файлове. Поддържай я актуална при смислени архитектурни промени.

## Основен потребителски поток
- Главният контейнер `App.tsx` управлява екрани чрез `currentScreen` state (`welcome` → `questionnaire` → `upload` → `analysis` → `report`) с допълнителни маршрути за история, настройки, информация и диагностика.
- Гардове: анализът се стартира само ако има валидни изображения и данни от въпросника; заключва се преходът по време на обработка чрез `screenTransitionLockRef`.
- Историята пази „леки“ отчети (без изображения), докато пълният отчет остава в памет за текущата сесия.

## Модели и данни
- Всички структури са описани в `src/types/index.ts` – въпросници (`QuestionnaireData`), изображения (`IrisImage`), анализи (`IrisAnalysis`), препоръки и AI конфигурация.
- При повторен анализ се рециклират последните изображения и отговори от въпросника, когато са налични.

## Персистентност
- Хукът `useKVWithFallback` държи критични данни (например история на анализи, настройки) с приоритет към IndexedDB и ограничен fallback към `localStorage` (<100KB), като автоматично се инициализира и синхронизира стойности.
- `multi-layer-storage.ts` предлага утилити за паралелно четене/запис в KV (Spark), IndexedDB и `localStorage` – полезно при нужда от ръчно управление извън хука.
- `storage-cleanup.ts` и `storage-utils.ts` оценяват заетостта и изтриват стари изображения при стартиране за да не се препълва браузърната памет.

## Логване и диагностика
- `error-logger.ts` поддържа кратък буфер от логове (до 50, с персист на последните 20 към KV) и слуша глобални `error`/`unhandledrejection` събития.
- `upload-diagnostics.ts` записва стъпките по качване/валидиране на изображения (start/success/warning/error) и позволява генерация на отчет за сесията.

## Админ и знания
- Екранът за настройки позволява конфигурация на AI доставчик (OpenAI/Gemini), ключове, темпо на заявки, както и зареждане на учебници, ръчни инструкции и шаблон на prompt за анализ; всички стойности се пазят през `useKVWithFallback`.
- Домейн знанието за ирисите (зони, артефакти, системи, диетични насоки) е централизирано в `src/lib/airis-knowledge.ts` и се използва от анализа/докладите.

## Бързи примерни стъпки за промени
- **Запазване на нова настройка:** `const [config, setConfig] = useKVWithFallback('custom-key', defaultValue); await setConfig({ ...config, foo: 'bar' })`.
- **Добавяне на екран:** разшири union типа `Screen` и добави блок във `AnimatePresence` с `<motion.div>` + `<Suspense>` както е при други екрани.
- **Използване на логовете:** `errorLogger.info('CONTEXT', 'Описание', { данни }); uploadDiagnostics.log('STEP', 'success', { meta });` за проследяване на критични пътеки.
