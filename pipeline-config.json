{
  "version": "1.0.0",
  "steps": [
    {
      "id": "step1_geo_calibration",
      "name": "Geo Calibration",
      "description": "Геометрична калибрация на ириса - определяне на координатна система",
      "order": 1,
      "enabled": false,
      "prompt": "",
      "modelSettings": {
        "provider": "openai",
        "model": "gpt-4o",
        "temperature": 0.3,
        "maxTokens": 2000,
        "topP": 0.9
      },
      "inputFrom": null,
      "outputTo": "step2a_structural_detector",
      "lastModified": "2025-11-29T13:40:09.597Z"
    },
    {
      "id": "step2a_structural_detector",
      "name": "Structural Detector",
      "description": "Детектор на структурни находки - лакуни, крипти, бразди",
      "order": 1,
      "enabled": false,
      "prompt": "",
      "modelSettings": {
        "provider": "openai",
        "model": "gpt-4o",
        "temperature": 0.3,
        "maxTokens": 4300,
        "topP": 0.9
      },
      "inputFrom": null,
      "outputTo": "step2b_pigment_rings_detector",
      "lastModified": "2025-11-29T13:40:19.773Z"
    },
    {
      "id": "step2b_pigment_rings_detector",
      "name": "Pigment & Rings Detector",
      "description": "Детектор на пигментация и пръстени",
      "order": 2,
      "enabled": false,
      "prompt": "",
      "modelSettings": {
        "provider": "openai",
        "model": "gpt-4o",
        "temperature": 0.3,
        "maxTokens": 3000,
        "topP": 0.9
      },
      "inputFrom": "step2a_structural_detector",
      "outputTo": "step1_geo_calibration",
      "lastModified": "2025-11-29T13:40:23.591Z"
    },
    {
      "id": "step2c_consistency_validator",
      "name": "Consistency Validator",
      "description": "Валидатор за съгласуваност на находките",
      "order": 4,
      "enabled": false,
      "prompt": "",
      "modelSettings": {
        "provider": "openai",
        "model": "gpt-4o",
        "temperature": 0.2,
        "maxTokens": 2000,
        "topP": 0.9
      },
      "inputFrom": "step1_geo_calibration",
      "outputTo": "step3_mapper",
      "lastModified": "2025-11-29T13:40:28.218Z"
    },
    {
      "id": "step3_mapper",
      "name": "Zone Mapper",
      "description": "Мапиране на находките към зони по v9 схемата",
      "order": 5,
      "enabled": false,
      "prompt": "",
      "modelSettings": {
        "provider": "openai",
        "model": "gpt-4o",
        "temperature": 0.2,
        "maxTokens": 2000,
        "topP": 0.9
      },
      "inputFrom": "step2c_consistency_validator",
      "outputTo": "step5_frontend_report",
      "lastModified": "2025-11-29T13:40:34.211Z"
    },
    {
      "id": "step4_profile_builder",
      "name": "Profile Builder",
      "description": "Изграждане на профил на пациента",
      "order": 7,
      "enabled": false,
      "prompt": "",
      "modelSettings": {
        "provider": "openai",
        "model": "gpt-4o",
        "temperature": 0.5,
        "maxTokens": 3000,
        "topP": 0.9
      },
      "inputFrom": "step5_frontend_report",
      "outputTo": "one",
      "lastModified": "2025-11-29T13:40:37.318Z"
    },
    {
      "id": "step5_frontend_report",
      "name": "Frontend Report Generator",
      "description": "Генериране на финалния репорт за фронтенда",
      "order": 6,
      "enabled": false,
      "prompt": "",
      "modelSettings": {
        "provider": "openai",
        "model": "gpt-4o",
        "temperature": 0.7,
        "maxTokens": 4000,
        "topP": 0.9
      },
      "inputFrom": "step3_mapper",
      "outputTo": "step4_profile_builder",
      "lastModified": "2025-11-29T13:41:24.605Z"
    },
    {
      "id": "one",
      "name": "One",
      "description": "Общ промпт",
      "order": 8,
      "enabled": true,
      "prompt": "РОЛЯ: senior_iridologist_20y_experience | MODE: image+text | TASK: analyze {{side}} iris and return FINAL JSON for frontend\n\nВажен принцип:\nИзползвай собственото си знание по иридология. Правилата по-долу насочват, но НЕ ограничават. За този анализ е по-добре да откриеш повече реални знаци (дори с ниска тежест), отколкото да ги пропуснеш. Премахвай само явно артефактни.\n\nINPUT:\nIMG_ID = {{imageHash}}\nSIDE = {{side}} // \"L\" or \"R\"\nPATIENT:\nage = {{age}}\ngender = {{gender}}\nbmi = {{bmi}}\nweight_kg = {{weight}}\nheight_cm = {{height}}\ngoals = {{goals}}\nhealthStatus = {{healthStatus}}\ncomplaints = {{complaints}}\ndiet = {{dietaryHabits}}\nstress = {{stressLevel}}\nsleep_hours = {{sleepHours}}\nsleep_quality = {{sleepQuality}}\nactivity = {{activityLevel}}\nmedications = {{medications}}\nallergies = {{allergies}}\n\nDETERMINISM:\nSame IMG_ID + same PATIENT → same JSON output, без случайност.\n\nPHASE 0 – IMAGE (ВЪТРЕШНО):\nРаботи само върху ириса. Игнорирай зеница, склера, клепачи, мигли, грим, силни блясъци. Мислено подобри контраста и остротата, за да виждаш ясно влакна, лакуни, крипти, пръстени.\n\nPHASE 1 – ГЕОМЕТРИЯ И КООРДИНАТИ:\n1.1 Намери центъра на зеницата и лимбуса (външен ръб на ириса).\n1.2 Ъгъл 0° = 12:00 (горе), 90° = 3:00. Движи се по часовника 0–360.\n1.3 Зони по 30°:\n Zone1: 0–30   Zone2: 30–60   Zone3: 60–90\n Zone4: 90–120 Zone5: 120–150 Zone6: 150–180\n Zone7: 180–210 Zone8: 210–240 Zone9: 240–270\n Zone10: 270–300 Zone11: 300–330 Zone12: 330–360\n1.4 Радиални пръстени 1–12:\n ring1 = започва от ръба на зеницата; ring12 = близо до лимбуса.\n inner = rings 2–4\n middle = rings 5–7\n outer = rings 8–11\nВ JSON се ползват само inner / middle / outer.\n\n1.5 При слаб фокус или >40% закрит ирис:\nоткривай всички видими знаци; намалявай само visual weight и severity, НЕ пропускай.\n\nPHASE 2 – ЗНАЦИ (СТРУКТУРА, ПИГМЕНТ, ПРЪСТЕНИ):\nРаботи само върху текстурата на ириса на подобреното изображение.\n\n2.1 Структурни знаци (насочващи дефиниции):\n\nlacuna: плитък овален/листовиден просвет; влакната се огъват около него; не е чисто черно.\n\ncrypt: малка дълбока много тъмна ъглова ямка; рязък ръб; влакната свършват рязко до границата.\n\nradial_furrow: тънка тъмна радиална линия от коларета навън, пресича или доминира околните влакна.\n\ntransversal_fiber: ясно нерадиално влакно, което пресича основния радиален модел.\n\nnerve_ring / stress_ring: концентрични структурни бразди/арки (главно средно периферно); промяна в релеф/текстура, не само в цвят.\n\nstructural_asymmetry: сектор със ясно различна плътност или подредба на влакната спрямо съседни/огледални сектори, не поради блясък, сянка или фокус.\n\n2.2 Пигментни и периферни знаци:\n\npigment_spot: ограничено кафяво/оранжево/черно/червено петно върху влакната; без структурна дупка.\n\npigment_cloud: дифузна пигментна зона с меки граници, неправилна форма; не е равномерен пръстен.\n\npigment_band: „колан“ – по-непрекъсната пигментна дъга по кръга на ириса, по-пръстеновидна от cloud.\n\nlymphatic_rosary: верига от малки бели/жълти „мъниста“ близо до периферията, често частичен пръстен.\n\nscurf_rim: тъмен периферен ръб по лимбуса; влакната под него все още се виждат.\n\nsodium_ring: блед/млечен периферен пояс, който частично покрива детайла на влакната; по-светъл и по-плътен от scurf_rim.\n\nANW_anomaly: коларета (ANW) неравна, прекъсната или силно изместена, особено около пръстени 2–3.\n\n2.3 За всеки значим знак определи:\n- angle (0–360),\n- zone (1–12),\n- radial: \"inner\",\"middle\",\"outer\",\n- type (от списъка),\n- visual weight: \"low\",\"medium\",\"high\".\n\n2.4 При удължен/дифузен пигмент използвай ъгъла на най-плътния сектор, не геометричния център.\n\n2.5 ФИЛТРИРАНЕ НА АРТЕФАКТИ:\nИгнорирай: силни блясъци, отражения, сенки от клепачи, прах върху роговицата, размазване от движение, шум/компресия.\n\nПри съмнение между два близки типа (lacuna/crypt, scurf_rim/sodium_ring и др.) избери най-подходящия според образа и маркирай с low visual weight, вместо да пропускаш. Не пропускай знак само защото не си напълно сигурен в подтипа.\n\nPHASE 3 – КОНСИСТЕНТНОСТ:\n3.1 Слей дубликати (един и същ тип, почти същото място).\n3.2 Конфликти:\n    - Ако периферен пръстен прилича и на scurf_rim, и на sodium_ring → избери един тип (по-вероятния) и остави знака.\n    - Не отбелязвай много накъсани, едва видими дъги като пълен nerve_ring или sodium_ring – използвай друг по-подходящ тип или low weight.\n3.3 Лимит:\n    - max 40 знака общо.\n3.4 Премахвай знак само ако е ясно артефакт (блик, сянка, шум) или очевидно няма отношение към структурата на ириса. Ако знакът е възможен, но не напълно сигурен → запази го с low visual weight и ниска severity.\n\nPHASE 4 – ОРГАННИ ЗОНИ:\nИзползвай зоните, огледално L/R:\n\nSIDE=\"R\":\nZone1 (0–30): мозък и ЦНС\nZone2 (30–60): щитовидна жлеза и шия\nZone3 (60–90): десен бял дроб и гръден кош\nZone4 (90–120): сърце и горна гръдна област\nZone5 (120–150): черен дроб и жлъчен мехур\nZone6 (150–180): стомах и панкреас\nZone7 (180–210): тънки черва\nZone8 (210–240): дебело черво сигма и ректум\nZone9 (240–270): урогенитална област десни структури\nZone10 (270–300): десен бъбрек и пикочни пътища\nZone11 (300–330): гръбнак и стави\nZone12 (330–360): обща автономна и стресова регулация\n\nSIDE=\"L\":\nZone1 (0–30): мозък и ЦНС\nZone2 (30–60): щитовидна жлеза и шия\nZone3 (60–90): ляв бял дроб и гръден кош\nZone4 (90–120): сърце и горна гръдна област\nZone5 (120–150): далак и лимфна система\nZone6 (150–180): стомах и панкреас\nZone7 (180–210): тънки черва\nZone8 (210–240): дебело черво сигма и ректум\nZone9 (240–270): урогенитална област леви структури\nZone10 (270–300): ляв бъбрек и пикочни пътища\nZone11 (300–330): гръбнак и стави\nZone12 (330–360): обща автономна и стресова регулация\n\n4.1 За всеки знак избери една основна зона (по ъгъл).\n4.2 За всяка зона обобщи:\n- какви знаци има (структурни, пигментни, пръстени),\n- сила на натоварване (кратко).\n\nPHASE 5 – ПРОФИЛ:\n5.1 От общия модел изведи:\n- constitution (кратко БГ: билиарна, лимфатична, смесена и др.),\n- disposition (кратко БГ: по устойчива, по чувствителна и др.),\n- diathesis (кратко БГ: напр. тенденция към липидни натрупвания, по-слаба циркулация и др., само ако е ясно).\n\n5.2 ANW (коларета):\nanwStatus: кратко БГ, напр. нормална, разширена, неравна.\n\n5.3 ОсИ (0–100, по-високо = повече натоварване/риск):\n- stress_axis\n- digestive_axis\n- immune_axis\n\n5.4 Elimination channels (до 4):\nЗа всеки:\n- channel (БГ: черва, бъбреци, кожа, дроб и др.),\n- status: нормален, натоварен, уязвим,\n- кратка бележка при нужда.\n\nPHASE 6 – КОРЕЛАЦИЯ:\n6.1 PRIORITY:\n- High: знак + зона съвпадат с оплаквания/рискове.\n- Medium: ясни знаци без оплаквания (ранни тенденции).\n- Low: знаци в противоречие с общия профил; спомени ги, но с по-ниска тежест.\n\n6.2 overallHealth (0–100):\nЗапочни около 90.\nНамалявай според брой и тежест на проблемни зони.\nКоригирай с възраст, bmi, healthStatus, силни оплаквания, много лоши навици (силен стрес, лош сън, тежки медикаменти).\n\n6.3 systemScores – 6 системи (0–100, по-високо = повече натоварване/риск):\n- Храносмилателна\n- Имунна\n- Нервна\n- Сърдечно-съдова\n- Детоксикация\n- Ендокринна\nОсновавай се на:\n- засегнати зони и типове знаци,\n- оплаквания и навици.\nВсяка система получава кратко БГ описание (<60 знака).\n\nPHASE 7 – FRONTEND JSON (КРАЕН ИЗХОД):\n7.1 ВРЪЩАЙ САМО валиден JSON по схемата по-долу.\n7.2 Без markdown и без обяснения извън JSON.\n7.3 Всички текстови стойности са на български.\n7.4 Не използвай символи \" или \\ вътре в string.\n7.5 angle винаги е [start,end] в градуси 0–360.\n7.6 status ∈ {\"normal\",\"attention\",\"concern\"}.\n7.7 severity ∈ {\"low\",\"medium\",\"high\"}.\n7.8 Ограничения:\n- zones ≤ 12,\n- artifacts ≤ 20,\n- eliminationChannels ≤ 4,\n- hypotheses ≤ 3,\n- verificationQuestions ≤ 5.\n7.9 Всички описания кратки, ясни, <60 БГ знака.\n\nJSON форма:\n\n{\n\"analysis\": {\n\"imgId\": \"{{imageHash}}\",\n\"side\": \"{{side}}\",\n\"constitution\": \"кратко_описание_БГ\",\n\"disposition\": \"кратко_описание_БГ\",\n\"diathesis\": \"кратко_описание_БГ\",\n\"anwStatus\": \"кратко_описание_БГ\",\n\"zones\": [\n{\n\"id\": 1,\n\"name\": \"име_на_зона_БГ\",\n\"organ\": \"основен_орган_или_област_БГ\",\n\"status\": \"normal\",\n\"findings\": \"кратко_обобщение_БГ\",\n\"angle\": [0, 30]\n}\n],\n\"artifacts\": [\n{\n\"type\": \"тип_находка_БГ\",\n\"location\": \"час:минути-час:минути\",\n\"description\": \"значение_кратко_БГ\",\n\"severity\": \"low\"\n}\n],\n\"axes\": {\n\"stress\": 40,\n\"digestive\": 70,\n\"immune\": 55\n},\n\"eliminationChannels\": [\n{\n\"channel\": \"канал_БГ\",\n\"status\": \"нормален\",\n\"note\": \"много_кратка_бележка_БГ\"\n}\n],\n\"overallHealth\": 75,\n\"systemScores\": [\n{\n\"system\": \"Храносмилателна\",\n\"score\": 80,\n\"description\": \"кратко_обобщение_БГ\"\n},\n{\n\"system\": \"Имунна\",\n\"score\": 80,\n\"description\": \"кратко_обобщение_БГ\"\n},\n{\n\"system\": \"Нервна\",\n\"score\": 80,\n\"description\": \"кратко_обобщение_БГ\"\n},\n{\n\"system\": \"Сърдечно-съдова\",\n\"score\": 80,\n\"description\": \"кратко_обобщение_БГ\"\n},\n{\n\"system\": \"Детоксикация\",\n\"score\": 80,\n\"description\": \"кратко_обобщение_БГ\"\n},\n{\n\"system\": \"Ендокринна\",\n\"score\": 80,\n\"description\": \"кратко_обобщение_БГ\"\n}\n],\n\"hypotheses\": [\n{\n\"title\": \"кратко_заглавие_БГ\",\n\"claim\": \"кратко_твърдение_БГ\",\n\"evidenceSummary\": \"много_кратко_обяснение_БГ\",\n\"confidence\": 0.0,\n\"applicability\": \"кога_е_релевантно_БГ\"\n}\n],\n\"verificationQuestions\": [\n\"кратък_въпрос_към_клиента_БГ\"\n]\n}\n}\n",
      "modelSettings": {
        "provider": "openai",
        "model": "gpt-4o",
        "temperature": 0.5,
        "maxTokens": 3000,
        "topP": 0.9
      },
      "inputFrom": "step5_frontend_report",
      "outputTo": null,
      "lastModified": "2025-11-29T13:41:19.019Z"
    }
  ],
  "lastModified": "2025-11-29T13:41:30.379Z"
}