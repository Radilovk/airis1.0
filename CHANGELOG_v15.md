# Changelog - –ò—Ç–µ—Ä–∞—Ü–∏—è 15

## üéØ –û—Å–Ω–æ–≤–µ–Ω –ø—Ä–æ–±–ª–µ–º: –ú–æ–¥–µ–ª –∏ Rate Limit

**–ü—Ä–æ–±–ª–µ–º—ä—Ç –±–µ—à–µ:** 
–í—ä–ø—Ä–µ–∫–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ –≤ –ò—Ç–µ—Ä–∞—Ü–∏—è 14, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ **–≤—Å–µ –æ—â–µ –∏–∑–ø–æ–ª–∑–≤–∞—à–µ –≤–≥—Ä–∞–¥–µ–Ω–∏—è GitHub Spark –º–æ–¥–µ–ª** –≤–º–µ—Å—Ç–æ –∏–∑–±—Ä–∞–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∞. Rate limit –≥—Ä–µ—à–∫–∏—Ç–µ (429 Too many requests) –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞—Ö–∞ –¥–∞ —Å–µ –ø–æ—è–≤—è–≤–∞—Ç.

---

## ‚úÖ –ù–∞–ø—Ä–∞–≤–µ–Ω–∏ –ø—Ä–æ–º–µ–Ω–∏

### 1. **–§–∏–∫—Å–∏—Ä–∞–Ω –∏–∑–±–æ—Ä –Ω–∞ –º–æ–¥–µ–ª**

**–ü—Ä–µ–¥–∏:**
```typescript
const callLLMWithRetry = async (
  prompt: string,
  modelName: string = 'gpt-4o',  // ‚ùå –í–∏–Ω–∞–≥–∏ –∏–∑–ø–æ–ª–∑–≤–∞ gpt-4o
  jsonMode: boolean = true
)
```

**–°–µ–≥–∞:**
```typescript
const callLLMWithRetry = async (
  prompt: string,
  jsonMode: boolean = true,  // ‚úÖ –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç modelName –ø–∞—Ä–∞–º–µ—Ç—ä—Ä
  maxRetries: number = 3
)
```

–°–µ–≥–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ **–≤–∏–Ω–∞–≥–∏ —á–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –æ—Ç `aiConfig`** –∏ –ø—Ä–∞–≤–∏–ª–Ω–æ –∏–∑–ø–æ–ª–∑–≤–∞:
- –°–æ–±—Å—Ç–≤–µ–Ω API –∫–ª—é—á –∞–∫–æ –µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- –ò–ª–∏ GitHub Spark –º–æ–¥–µ–ª `gpt-4o-mini` (–ø–æ-–ª–µ–∫ –º–æ–¥–µ–ª = –ø–æ-–º–∞–ª–∫–æ rate limit)

### 2. **–ü—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ –∫—ä–º gpt-4o-mini –∑–∞ –≤–≥—Ä–∞–¥–µ–Ω–∏—è –º–æ–¥–µ–ª**

GitHub Spark –∏–º–∞ rate limit –Ω–∞ –∑–∞—è–≤–∫–∏. –ó–∞ –¥–∞ –Ω–∞–º–∞–ª–∏–º —Ä–∏—Å–∫–∞ –æ—Ç "429 Too many requests":
- –ü—Ä–æ–º–µ–Ω–∏—Ö–º–µ –æ—Ç `gpt-4o` (–ø–æ-—Ç–µ–∂—ä–∫) –Ω–∞ `gpt-4o-mini` (–ø–æ-–ª–µ–∫ –∏ –ø–æ-–±—ä—Ä–∑)
- –¢–æ–≤–∞ –Ω–∞–º–∞–ª—è–≤–∞ –Ω–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ—Ç–æ –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—Ç–∞ –æ—Ç rate limit

```typescript
if (useCustomAPI) {
  // –ò–∑–ø–æ–ª–∑–≤–∞ –≤–∞—à–∏—è API –∫–ª—é—á
  response = await callExternalAPI(...)
} else {
  // –ò–∑–ø–æ–ª–∑–≤–∞ GitHub Spark —Å –ø–æ-–ª–µ–∫–∞—Ç–∞ –≤–µ—Ä—Å–∏—è
  response = await window.spark.llm(prompt, 'gpt-4o-mini', jsonMode)
}
```

### 3. **–£–≤–µ–ª–∏—á–µ–Ω–∏ –∏–∑—á–∞–∫–≤–∞–Ω–∏—è –∑–∞ GitHub Spark –º–æ–¥–µ–ª**

–ó–∞ –¥–∞ –∏–∑–±–µ–≥–Ω–µ–º rate limit –ø—Ä–∏ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ –≤–≥—Ä–∞–¥–µ–Ω–∏—è –º–æ–¥–µ–ª:

**–ò–∑—á–∞–∫–≤–∞–Ω–∏—è –º–µ–∂–¥—É AI –∑–∞—è–≤–∫–∏:**
- –°—ä—Å —Å–æ–±—Å—Ç–≤–µ–Ω API: **3 —Å–µ–∫—É–Ω–¥–∏**
- –° GitHub Spark: **60 —Å–µ–∫—É–Ω–¥–∏** (–±–µ—à–µ 30)

**–ò–∑—á–∞–∫–≤–∞–Ω–∏—è –ø—Ä–∏ rate limit –≥—Ä–µ—à–∫–∞:**
- –°—ä—Å —Å–æ–±—Å—Ç–≤–µ–Ω API: **15 —Å–µ–∫—É–Ω–¥–∏**
- –° GitHub Spark: **120 —Å–µ–∫—É–Ω–¥–∏** (2 –º–∏–Ω—É—Ç–∏)

```typescript
const waitTime = aiConfig?.useCustomKey ? 3000 : 60000
await sleep(waitTime)
```

### 4. **–ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–∏ –Ω–µ–∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏**

–í—Å–∏—á–∫–∏ –∏–∑–≤–∏–∫–≤–∞–Ω–∏—è –Ω–∞ `callLLMWithRetry()` —Å–∞ –æ–ø—Ä–æ—Å—Ç–µ–Ω–∏:

**–ü—Ä–µ–¥–∏:**
```typescript
const response = await callLLMWithRetry(prompt, modelToUse, true)
```

**–°–µ–≥–∞:**
```typescript
const response = await callLLMWithRetry(prompt, true)
```

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ —Å–µ —á–µ—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç `aiConfig`.

---

## üìä –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ –≤—Ä–µ–º–µ–Ω–∞ –∑–∞ –∞–Ω–∞–ª–∏–∑

| –†–µ–∂–∏–º | –û–±—â–æ –≤—Ä–µ–º–µ | –î–µ—Ç–∞–π–ª–∏ |
|-------|------------|---------|
| **–°—ä—Å —Å–æ–±—Å—Ç–≤–µ–Ω API –∫–ª—é—á** | **40-60 —Å–µ–∫** | 4 AI –∑–∞—è–≤–∫–∏ + 3 —Å–µ–∫ √ó 3 –∏–∑—á–∞–∫–≤–∞–Ω–∏—è = ~50 —Å–µ–∫ |
| **GitHub Spark (gpt-4o-mini)** | **4-5 –º–∏–Ω—É—Ç–∏** | 4 AI –∑–∞—è–≤–∫–∏ + 60 —Å–µ–∫ √ó 3 –∏–∑—á–∞–∫–≤–∞–Ω–∏—è = ~4 –º–∏–Ω |

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –¥–µ—Ç–∞–π–ª–∏

### –ü—Ä–æ–º–µ–Ω–µ–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏

#### `callLLMWithRetry()`
```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è –¥–∞–ª–∏ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞ —Å–æ–±—Å—Ç–≤–µ–Ω API –∏–ª–∏ GitHub Spark
const useCustomAPI = aiConfig?.useCustomKey && aiConfig?.apiKey
const provider = aiConfig?.provider || 'openai'
const actualModel = aiConfig?.model || 'gpt-4o'

if (useCustomAPI) {
  addLog('info', `üîß –†–µ–∂–∏–º: –°–æ–±—Å—Ç–≤–µ–Ω API (${provider} - ${actualModel})`)
  response = await callExternalAPI(prompt, provider, actualModel, aiConfig!.apiKey, jsonMode)
} else {
  addLog('info', `üîß –†–µ–∂–∏–º: GitHub Spark –≤–≥—Ä–∞–¥–µ–Ω –º–æ–¥–µ–ª (gpt-4o-mini –∑–∞ –ø–æ-–º–∞–ª–∫–æ –∑–∞—è–≤–∫–∏)`)
  response = await window.spark.llm(prompt, 'gpt-4o-mini', jsonMode)
}
```

#### Backoff —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏ –≥—Ä–µ—à–∫–∏
```typescript
if (errorMsg.includes('429') || errorMsg.includes('rate limit')) {
  const backoffTime = useCustomAPI ? 15000 : 120000  // 15 —Å–µ–∫ –∏–ª–∏ 2 –º–∏–Ω
  addLog('info', `‚è≥ –ò–∑—á–∞–∫–≤–∞–Ω–µ ${(backoffTime / 1000).toFixed(0)}s –ø—Ä–µ–¥–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω –æ–ø–∏—Ç...`)
  await sleep(backoffTime)
}
```

### –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ —Å—ä–æ–±—â–µ–Ω–∏—è –≤ UI

```typescript
<p className="text-xs text-muted-foreground leading-relaxed">
  ‚ÑπÔ∏è {aiConfig?.useCustomKey 
    ? `–ü—Ä–æ—Ü–µ—Å—ä—Ç —Å –≤–∞—à–∏—è ${aiConfig.provider === 'gemini' ? 'Gemini' : 'OpenAI'} API –∫–ª—é—á –æ—Ç–Ω–µ–º–∞ 30-60 —Å–µ–∫—É–Ω–¥–∏.` 
    : '–ü—Ä–æ—Ü–µ—Å—ä—Ç —Å GitHub Spark –º–æ–¥–µ–ª–∞ (gpt-4o-mini) –æ—Ç–Ω–µ–º–∞ 4-6 –º–∏–Ω—É—Ç–∏. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –∏–∑—á–∞–∫–≤–∞ 60 —Å–µ–∫—É–Ω–¥–∏ –º–µ–∂–¥—É –∑–∞—è–≤–∫–∏—Ç–µ –∑–∞ –∏–∑–±—è–≥–≤–∞–Ω–µ –Ω–∞ rate limit.'}
</p>
```

---

## üéØ –†–µ–∑—É–ª—Ç–∞—Ç

‚úÖ **–ú–æ–¥–µ–ª —Å–µ —Å–º–µ–Ω—è –ø—Ä–∞–≤–∏–ª–Ω–æ** - –ö–æ–≥–∞—Ç–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω API –∫–ª—é—á, —Ç–æ–π —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞  
‚úÖ **–ü–æ-–º–∞–ª–∫–æ rate limit –≥—Ä–µ—à–∫–∏** - –£–≤–µ–ª–∏—á–µ–Ω–∏ –∏–∑—á–∞–∫–≤–∞–Ω–∏—è –∏ –ø–æ-–ª–µ–∫ –º–æ–¥–µ–ª  
‚úÖ **–Ø—Å–Ω–∞ –∏–Ω–¥–∏–∫–∞—Ü–∏—è** - –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –≤–∏–∂–¥–∞ –∫–æ–π –º–æ–¥–µ–ª —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –≤ –ª–æ–≥–æ–≤–µ—Ç–µ  
‚úÖ **–ü–æ-–±—ä—Ä–∑ —Å API –∫–ª—é—á** - –°–∞–º–æ 40-60 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 4-5 –º–∏–Ω—É—Ç–∏  

---

## üí° –ü—Ä–µ–ø–æ—Ä—ä–∫–∏

### –ó–∞ —Ç–µ—Å—Ç–≤–∞–Ω–µ (–±–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω API –∫–ª—é—á)
- –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ GitHub Spark –≤–≥—Ä–∞–¥–µ–Ω–∏—è –º–æ–¥–µ–ª
- –ë—ä–¥–µ—Ç–µ —Ç—ä—Ä–ø–µ–ª–∏–≤–∏ - –ø—Ä–æ—Ü–µ—Å—ä—Ç –æ—Ç–Ω–µ–º–∞ 4-5 –º–∏–Ω—É—Ç–∏
- –ü—Ä–∞–≤–µ—Ç–µ —Å–∞–º–æ 1-2 –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ —á–∞—Å

### –ó–∞ –ø—Ä–æ–¥—É–∫—Ü–∏—è
1. **–ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –¥–æ–±–∞–≤–µ—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω API –∫–ª—é—á!**
2. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ OpenAI –∏–ª–∏ Gemini
3. –ü—Ä–µ–ø–æ—Ä—ä—á–∞–Ω–∏ –º–æ–¥–µ–ª–∏:
   - OpenAI: `gpt-4o` –∏–ª–∏ `gpt-4o-mini`
   - Gemini: `gemini-1.5-pro` –∏–ª–∏ `gemini-2.0-flash-exp`
4. –ü—Ä–æ–≤–µ—Ä—è–≤–∞–π—Ç–µ –ª–æ–≥–æ–≤–µ—Ç–µ –∑–∞ –≥—Ä–µ—à–∫–∏

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω–∏ –ø—Ä–æ–±–ª–µ–º–∏

1. **GitHub Spark –≤—Å–µ –æ—â–µ –∏–º–∞ rate limit** - –ë–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω API, –ª–∏–º–∏—Ç—ä—Ç –≤—Å–µ –æ—â–µ –º–æ–∂–µ –¥–∞ —Å–µ –¥–æ—Å—Ç–∏–≥–Ω–µ –ø—Ä–∏ –∏–Ω—Ç–µ–Ω–∑–∏–≤–Ω–∞ —É–ø–æ—Ç—Ä–µ–±–∞
2. **–î—ä–ª–≥–æ –∏–∑—á–∞–∫–≤–∞–Ω–µ** - 60 —Å–µ–∫—É–Ω–¥–∏ –º–µ–∂–¥—É –∑–∞—è–≤–∫–∏—Ç–µ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞ —Å—Ç–∞–±–∏–ª–Ω–æ—Å—Ç

---

**–î–∞—Ç–∞:** 2024  
**–í–µ—Ä—Å–∏—è:** –ò—Ç–µ—Ä–∞—Ü–∏—è 15  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –§–∏–∫—Å–∏—Ä–∞–Ω–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ –º–æ–¥–µ–ª, –Ω–∞–º–∞–ª–µ–Ω–∏ rate limit –≥—Ä–µ—à–∫–∏
