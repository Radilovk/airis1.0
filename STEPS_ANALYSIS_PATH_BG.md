# Какво точно правят prompt-овете в `steps/` (пътят на анализа, накратко)

Това е бърза карта на основния pipeline, извлечена директно от prompt-овете в папка `steps/`. Всеки етап е описан с вход, изход и кратък пример, за да се види как се предава контекстът към следващата стъпка.

## Стъпка 1: Геометрия и качество
- Вход: сурово изображение + страна (`R`/`L`).
- Роля: изчислява координатите на ириса по минутите и 12 концентрични пръстена, валидира качество и маркира дефектни области (specular/закрити зони).【F:steps/STEP1_geo_calibration.txt†L1-L92】
- Пример: ако лъчът на 3:00 (минутa 15) липсва или >35% от ириса е закрит, `ok=false` и анализът спира.

## Стъпка 2A: Структурни находки
- Вход: изображение + GEO от стъпка 1.
- Роля: търси структурни образувания (lacuna, crypt, radial_furrow и др.) и винаги връща minuteRange + ringRange, без диагноза.【F:steps/STEP2A_structural_detector.txt†L1-L71】
- Пример: `lacuna` в minuteRange 10–16, ringRange 2–3 със `size="m"` и confidence 0.78.

## Стъпка 2B: Пигментация и периферия
- Вход: изображение + GEO от стъпка 1.
- Роля: намира цветови/периферни признаци (pigment_spot, nerve_rings, scurf_rim, sodium_ring и др.), плюс базови конституционни тагове и коларетата.【F:steps/STEP2B_pigment_rings_detector.txt†L1-L87】
- Пример: `sodium_ring` в ringRange 10–11, minuteRange 40–55, severity `medium`, confidence 0.72.

## Стъпка 2C: Консистентност и чистене
- Вход: GEO + изходите от 2A/2B.
- Роля: маха противоречия (напр. scurf_rim vs sodium_ring), нормализира диапазони, реже твърде широки/несигурни находки и подготвя clean структури за следващите стъпки.【F:steps/STEP2C_consistency_validator.txt†L1-L78】
- Пример: ако `pigment_spot` припокрива `lacuna`, спотът се изхвърля; ако minuteRange се „обвива“ (58–2), се разделя на два диапазона.

## Стъпка 3: Картографиране към v9 зони
- Вход: GEO + CLEAN (2C) + топография MAP_V9 + страна.
- Роля: свързва всяка находка с най-точната v9 зона по страна + минути + пръстени, изчислява zoneSummary и предупреждава при масово немапнати находки.【F:steps/STEP3_mapper_v9.txt†L1-L51】
- Пример: `radial_furrow` с център в 225° (мин. 38) и ringRange 3–5 се мапва към зона `kidney_R` и влиза в `zoneSummary` като evidenceCount 1.

## Стъпка 4: Профил (RAG върху ръководството)
- Вход: MAPPED (3) + CLEAN (2C) + IRIS_RAG_v2 (ръководството).
- Роля: изчислява базови тагове (конституция, диатеза, ANW статус), канали за елиминация, оси (stress/digestive/immune) и компактни хипотези с цитирани доказателства (fid + zoneId).【F:steps/STEP4_profile_builder.txt†L1-L55】
- Пример: ако има силни ANW находки + коларета „expanded“, `gut_ANW` канал може да стане `attention` със съответните fid/zoneId.

## Стъпка 5: Финален фронтенд отчет (BG)
- Вход: GEO + CLEAN + MAPPED + PROFILE + ръководство + въпросник.
- Роля: генерира български JSON за UI (12 фиксирани зони с орган/статус/кратко резюме), артефакти, системни оценки и препоръки; органите/системите идват единствено от v9 мапинга.【F:steps/STEP5_frontend_report_bg.txt†L1-L126】
- Пример: зона 4 (3–4ч) → „черен дроб“, статус `attention`, findings „стрес-арки“; артефакт: `nerve_rings` 3:00–4:00 със severity `medium`.

## Най-кратката верига (виж пътя на данните)
1) Стъпка 1 филтрира невалидни снимки и дава координати.
2) 2A/2B ловят структури и пигментация отделно.
3) 2C почиства и обединява в CLEAN.
4) 3 мапва CLEAN към v9 зони.
5) 4 строи профил върху ръководството + мапнатите доказателства.
6) 5 превежда всичко в български UI JSON, валидиран срещу въпросника.

## Бързи идеи за подобрение
- **Карта + изображение към модела:** увери се, че към стъпки 2A/2B се подава композитното изображение с overlay, за да не се губи локализация (проблемът с „чисти“ резултати идваше от липсваща карта).
- **Логове за версията на prompt-овете:** показвай `checksum`/`source` от каталога в admin панела, за да се хващат несъответствия между заредени стъпки и очакваните файлове.
- **Лека строгост в 2C:** ако честo има разминаване между scurf_rim и sodium_ring, може да вдигнеш прага за overlap от 50% на 60% за по-малко агресивно изхвърляне.
